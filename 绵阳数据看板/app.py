import streamlit as st
import os
import pandas as pd
import base64
from data_utils import process_chain_data
import visual_utils as vis

st.set_page_config(page_title="绵阳产业链数字化画像审计看板", layout="wide")

# 获取当前脚本所在的绝对路径
BASE_DIR = os.path.dirname(os.path.abspath(__file__))

# 动态拼接路径，确保无论在哪里运行都能找到 data 文件夹
DATA_DIR = os.path.join(BASE_DIR, "data")

SPECIAL_5 = ["科技光子类", "科技低空类", "科技绿能类", "科技核医疗类", "科技机器人类"]

@st.cache_data
def load_all_data(dir):
    files = [f for f in os.listdir(dir) if f.endswith(".xlsx") and not f.startswith("~$")]
    all_raw, mets = [], []
    for f in files:
        name = f.replace(".xlsx", "")
        df_tmp = process_chain_data(pd.read_excel(os.path.join(dir, f)))
        mets.append({"产业名称": name, "企业数量": df_tmp['公司名称'].nunique(), "平均资质数": df_tmp['资质总量_f'].mean(), "分类": "重点产业" if name in SPECIAL_5 else "其他产业"})
        df_tmp['所属产业集群'] = name
        all_raw.append(df_tmp)
    return pd.concat(all_raw, ignore_index=True), pd.DataFrame(mets)

# --- 导航中心 ---
st.sidebar.markdown("# 🛰️ 绵阳产业审计调度舱")
selected_module = st.sidebar.radio("任务切换：", ["📍 绵阳企业产业分布一览", "🤖 机器人产业链案例解析", "📄 企业专项审计报告"])

df_all, df_mets = load_all_data(DATA_DIR)

# =================================================================
# 模块 1：绵阳企业产业分布一览
# =================================================================
if selected_module == "📍 绵阳企业产业分布一览":
    st.title("🏙️ 绵阳全市企业产业分布一览")
    df_u = df_all.drop_duplicates(subset=['公司名称'])

# 图 1
    st.pyplot(vis.plot_mianyang_ranking(df_mets, "企业数量", "1. 企业数量分布（产业规模格局）"))
    st.markdown("""
    - **核心发现**：绵阳产业呈现 **“基础雄厚、重点突出、新兴崛起”** 的格局。
    - **具体解析**：
        - **基础产业**：**软件服务（1000家）** 企业数量绝对领先，构成绵阳的数字经济底座。
        - **主导集群**：**成渝电子信息（700家）** 与 **医疗健康（600家）** 是绵阳传统优势产业，集群效应显著。
        - **新兴力量**：**人工智能（400家）**、**科技机器人类（250家）** 等已形成相当规模，是转型升级的关键增量。
        - **市场容量**：软件服务、电子信息企业基数大，是普惠金融与结算服务的广阔市场。科技机器人类企业数量（250家）在全市居**中游偏上**，表明其并非“小众”产业，已形成一定的集群基础，可作为特色赛道进行深耕。
    """)
    st.divider()

    # 图 2
    st.pyplot(vis.plot_mianyang_ranking(df_mets, "平均资质数", "2. 平均资质数分布（企业获得资质荣誉称号数量）"))
    st.markdown("""
    - **核心发现**：企业“软实力”（企业资质总量：获得资质荣誉数目）与产业“硬科技”属性相关，**高端制造与精密技术产业普遍获得更多地荣誉资质**。
    - **具体解析**：
        - **资质高地**：**高端能源制造（7.2）、航空航天集群（6.8）** 等资质得分最高，反映这些技术门槛高、战略属性强的产业很受政策扶持，企业合规性与背书能力强。
        - **中坚力量**：**科技机器人类（6.0）** 处于全市**中上水平**，显著高于软件服务（3.6）、人工智能（4.2）等产业，说明其作为重点培育的先进制造业，获得了相对更多的资质认可。
        - **起步领域**：低空经济相关产业资质数偏低，处于发展早期。
    """)
    st.success("""
    **阶段总结**：可以结合集群规模（企业数量）与政策认可（荣誉资质数目）双重基础，综合评判各个产业集群地发展状况，跳出单一企业视角，建立“产业坐标”，实施“因业施策”。  
    例如：**科技机器人产业**在绵阳产业版图中，科技机器人属于 **“新兴主导产业”**——企业数量已有相当基础（250家），且官方认可度（资质分6.0）处于中上水平。
    """)
    st.divider()


# --- 图 3：重点科技产业之区县分布 ---
    st.pyplot(vis.plot_special_geo_stacked(df_all, SPECIAL_5))
    
    st.markdown("""
    -  **分布特征：极度集聚** 

    - **绝对3核**：所有产业在 **涪城区** 遥遥领先，占绝大多数。**游仙区、安州区** 的企业数量也相对较多，3者合计占比预计超过70% 。其中涪城区在各个重点关注领域的企业数目都客观，但核医疗企业相对较多的集中在游仙区 。
    
    - **外围稀疏**：其他七个区县（三台、北川、安州、平武、梓潼、游仙、盐亭）的企业数量普遍在20家左右，且各产业分布均匀偏低，未形成特色集群。
    """)

    # --- 总结 (精准还原 PDF 原文) ---
    st.success("""
    **总结**：可以继续重点关注 **涪城区** 和 **游仙区、安州区** 3大高地，可实现对全市重点科技企业的高效覆盖 。适度的考虑跨区县分散，下沉寻找机遇，在外围区县中， **江油市、北川羌族自治县、平武县、三台县** 在部分产业上数量略高（10-20家），可作为次级潜力区域进行扫描，挖掘其中具有独特技术或市场优势的“小而美”企业，以优化区域布局 。
    """)
    
    st.divider()
    # 图 4, 5, 6
    st.pyplot(vis.plot_scale_pie(df_u, "4. 全市企业规模结构"))
    st.markdown("""
    #### **1. 企业规模结构**
    微型企业（66.0%）与小型企业（25.7%）合计占比超90%，大型企业仅占6.3%。绵阳企业生态呈现典型的 **“小微主体”** 特征。
    """)
    st.divider()

    st.pyplot(vis.plot_region_bar(df_u, "5. 全市企业地理聚集情况"))
    st.markdown("""
    #### **2. 地理分布**
    **企业高度集中于 **“涪城区”（近1750家）** ，占绝对主导；第二梯队（游仙区、安州区、江油市）数量骤降（200-300家），产业发展**地理集中度极高**。
    """)
    st.divider()

    st.pyplot(vis.plot_age_dist(df_u, "6. 全市企业成立年限分布"))
    st.markdown("""
    #### **3. 成立年限分布**
    企业数量随成立年限增加而 **快速递减**，成立时间短的企业占绝大多数。
    全市企业群体 **年轻化** 特征突出，反映经济活力，但也意味着大量企业缺乏长期信用记录和周期考验， **评估时需侧重成长性与技术潜力，而非历史财务数据**。
    """)
    st.warning("**阶段总结**：基于全部分析，绵阳市呈现 **“小微、年轻、高集聚”** 的鲜明特征。")

# =================================================================
# 模块 4：机器人产业链案例解析
# =================================================================
elif selected_module == "🤖 机器人产业链案例解析":
    st.title("🤖 机器人产业链——深度穿透解析案例")
    df_robot = process_chain_data(pd.read_excel(os.path.join(DATA_DIR, "科技机器人类.xlsx")))
    df_p = df_robot[df_robot['专利数量_f'] > 0].copy()

    # --- 第一阶段 ---
    st.subheader("一、 第一阶段：全量背景画像分析")
    
    # 规模
    st.pyplot(vis.plot_scale_pie(df_robot, "科技机器人类企业规模分布"))
    st.markdown("""
    - **结构特征**：微型（64.2%）与小型（29.2%）企业合计占比超 **93%**，表明产业 **创新活跃但格局分散**，尚未形成由大型龙头主导的成熟集群。
    - **业务实质**：这反映出本地产业仍以 **初创型、专业化项目** 为主，整体处于技术孵化与市场探索期。
    """)
    st.success("**阶段总结**：产业基础广泛，但需识别并助力潜在骨干企业成长，以提升集群稳定性。")
    st.divider()

    # 资本
    st.pyplot(vis.plot_capital_dist(df_robot))
    st.markdown("""
    - **结构特征**：超八成企业（150家）注册资本在 **1000万元以下**，其中100-500万区间最为集中（80多家）。这与“小微企业主导”的规模结构相互印证，表明多数企业处于 **轻资产运营** 的初创或成长阶段。
    - **实力分层**：注册资本在 **5000万元以上的企业仅10多家**（占约6%），说明产业头部力量仍较薄弱，缺乏资本雄厚的大型领军企业。
    """)
    st.success("**阶段总结**：产业资本基础以中小规模为主，避免因“小资本”而低估优质技术型企业的潜力。")
    st.divider()

    # 成立年限
    st.pyplot(vis.plot_age_dist(df_robot, "科技机器人类企业成立年限分布"))
    st.markdown("""
    - **行业阶段**：绝大多数企业成立年限 **以0-5年为主，大多在15年以内**，表明该产业的企业是在近年政策与技术驱动下 **快速形成的新兴集群**，而非传统产业升级。
    -  **1**：大量年轻企业意味着 **缺乏长期信用记录** 与 **完整经济周期考验**，需要审慎看待经营不确定性。
    -  **2**：这恰好对应了企业的 **早期融资需求窗口**。若能挖掘高技术价值的企业，可抢占先机，培育未来核心客户。
    - **交叉验证**：此特征与前两张图的“小微主体”、“轻资本”结构高度一致，共同印证产业处于 **初创期**。
    """)
    st.success("**阶段总结**：产业年轻充满活力，但评估侧重点可以从“看历史”转向“评未来”，重点考察其技术护城河等技术性方面。")
    st.divider()

    # 风险
    st.pyplot(vis.plot_risk_barh(df_robot))
    st.markdown("**风险企业极少**：属于该类别的企业总共200多家，“被执行人”（11家）、“行政处罚”（10家）、“失信被执行人”（1家）占比极低。")
    st.success("**阶段总结**：说明大多数企业目前都是**经营合规**，可靠性比较稳定。")
    st.divider()

    # 资质
    st.pyplot(vis.plot_qual_dist(df_robot))
    st.markdown("""
    1. **整体薄弱**：（资质总量是企业获得的荣誉称号的数量）多数企业集中于资质数量50以内，表明 **对于中小型为多的新企业来，荣誉称号数量不多但尚可**，整体产业形象与品牌建设处于早期。
    2. **分化明显**：少量企业拥有较多资质荣誉称号，反映出 **政策资源与认可度集中于少数企业**。
    """)
    st.success("**阶段总结**：产业整体荣誉资质积累有待提高，可以重点关注那些兼具高资质与高技术指标的优质企业。")
    st.divider()

    # 地理
    st.pyplot(vis.plot_region_bar(df_robot, "科技机器人类企业区县分布"))
    st.markdown("""
    1. **格局集中**：仅 **涪城区+游仙区+安州区（200多家）** 便汇聚了几乎所有的企业，占比远超其他区的总和，表明产业资源、人才与政策高度集中于城市核心区。
        
    2. **区域失衡**：其余区县企业数量占比少，反映出产业辐射与扩散能力 **有待提升**，区域协同发展格局有待进一步构建。
    """)
    st.success("**阶段总结**：产业地理分布高度集中，可以采取“聚焦核心涪城区、同时关注其他梯队”的区域策略，可关注游仙区、安州区等第二梯队中具有技术特色的企业，进行前瞻性布局，以分散区域风险。")
    st.divider()

    # --- 第二阶段 ---
    st.subheader("二、 第二阶段：核心指标联动分析")
    stabs = st.tabs(["📊 指标联动", "🫧 研发聚焦", "💰 资本审美", "🕒 年限演进"])

    with stabs[0]:
        # 1. 业务支撑指数
        st.markdown("#### **1. 业务支撑指数**")
        c1a, c1b = st.columns(2)
        with c1a: 
            st.pyplot(vis.plot_metric_trend(df_p, '支撑得分', '业务支撑指数', 0.31))
            st.markdown("""
            - **核心发现**：专利数量与业务支撑指数**仅呈弱相关（R=0.31）**。大量专利（横坐标右侧）并未带来相应的高支撑得分，反之，部分专利不多的企业却得分很高。这直接**戳破了“专利多等于技术强”的误区**。需警惕 **“专利泡沫”**（即专利数量庞大但与本业关联度低），这类企业研发可能不够聚焦
        """)
        with c1b: 
            st.pyplot(vis.plot_metric_violin(df_p, '支撑得分', '业务支撑指数'))
            st.markdown("""
            - **核心发现**：不同规模企业的业务支撑指数**分布高度重叠且离散**。相对而言，规模越大平均得分越高，但是大型企业得分并非全部领先，而众多**微型、小型企业中不乏高分群体**，企业规模并非技术变现能力的可靠保证，传统基于企业规模的判别方式可能**漏掉优质中小企业**。
        """)
        st.success("**阶段总结**：利用“业务支撑指数”快速识别两类企业：1）研发高度聚焦、变现路径清晰的核心客群（无论规模大小，看支撑度）；2）专利虽多但偏离主业、研发效率可疑的需警惕对象。优先支持各规模段中得分领先的企业，尤其是中小微企业中的高分者，它们可能是成长性最佳的目标。")
        st.divider() 

        # 2. 技术护城河
        st.markdown("#### **2. 技术护城河深度**")
        c2a, c2b = st.columns(2)
        with c2a: 
            st.pyplot(vis.plot_metric_trend(df_p, '护城河得分', '技术护城河深度', 0.14))
            st.markdown("""
            - **核心发现**：两者几乎无关（R=0.14）。图表中大量专利堆砌（右侧）未能推高护城河得分，而一些专利量中等的企业（中间区域）反而得分突出， **“专利质量”比“专利数量”更能构筑壁垒**。
            - **注意**：重点关注**护城河得分高的企业**，无论其专利总数多少。这代表了它们在特定技术点上已建立起 **“非对称优势”** ，具备抗风险能力。
        """)
        with c2b: 
            st.pyplot(vis.plot_metric_violin(df_p, '护城河得分', '技术护城河深度'))
            st.markdown("""
        - **核心发现**：大型企业并未垄断高分，中小型企业中出现了一批“细分领域技术领先者”。因此，企业规模并不完全等同于技术壁垒，可以在中小规模的企业里找到一些深厚壁垒的“隐形冠军”。
        """)
        st.success("**阶段总结**：对得分高的企业，即使其规模不大或财务历史较短，也可以作为重点关注对象，因为其核心技术构成了强大的竞争优势。可将“技术护城河深度”作为发掘 **“专精特新”潜力股的辅助筛选工具**，关注中小微企业中该指标得分靠前的企业，它们具备高成长性。")
        st.divider()

        # 3. 产品技术覆盖率
        st.markdown("#### **3. 产品技术覆盖率**")
        c3a, c3b = st.columns(2)
        with c3a: 
            st.pyplot(vis.plot_metric_trend(df_p, '覆盖得分', '产品技术覆盖率', 0.02))
            st.markdown("""
            - **核心发现**：拥有大量专利的极个别企业产品覆盖度可能较低，其产品线可能仍存在无专利保护的“裸奔”区域，暴露了 **专利布局的战略性缺陷**。代表专利再多，若未有效覆盖核心产品，则企业经营存在被竞争对手轻易模仿或攻击的 **高风险点**。
        """)
        with c3b: 
            st.pyplot(vis.plot_metric_violin(df_p, '覆盖得分', '产品技术覆盖率'))
            st.markdown("""
            - **核心发现**：
            - **大型企业（平均45分左右）**：整体得分相对集中趋于60分，整体较高，但与中型企业差距不显著，即它的业务可能庞杂或依赖存在少数核心专利的情况，相对边缘的业务覆盖度不够，存在“灯下黑”风险，但其得分显著高于小型和微型企业，。
            - **小型企业（平均40分左右）**：处于高速成长期，对知识产权保护意识最强，是**风控与业务机会的平衡点**，存在少数优质企业覆盖度指标优异。
            - **微型企业（平均20分左右）**：资源有限，专利布局严重不足，生存根基不牢。
        """)
        st.success("**阶段总结**：“产品技术覆盖率”是经营风险的“X光片”，可重点关注覆盖率高的小型和中型企业，它们增长意愿强且风控意识好。")

    with stabs[1]:
        st.pyplot(vis.plot_bubble_chart(df_p))
        st.markdown("""
        ##### **1. 直接表现**
        - 图表显示，**业务支撑指数（研发聚焦度）与技术护城河深度有一定的正相关趋势**（回归线向上），表明研发越聚焦的企业，可能在特定领域建立起深厚的技术壁垒。
        - 图中气泡大小（专利数量）分布不均：**右上象限（双高区域）存在一些专利量较大的企业，但也不乏专利量中等或偏小的企业**；左下象限（双低区域）企业专利量普遍偏小。
        
        ##### **2. 业务与指标逻辑解读**
        - **逻辑**：研发聚焦（业务支撑指数高）意味着企业将有限资源集中投入到与主营业务最相关的技术上，这种持续、专注的投入更容易在细分赛道形成专利集群和领先优势，从而垒高“技术护城河”。这张图清晰地揭示了 **“技术领先企业”的共性特征**：**既聚焦主业，又能在点上打穿**。这类企业兼具了 **“高变现效率”与“强竞争壁垒”**，具有较好的成长性与安全性。
        - **精准定位**：可重点关注 **图中右上象限的企业**。它们代表了绵阳机器人产业中 **技术最健康、模式最清晰、风险最低** 的群体。对 **左下象限（双低）** 的企业应保持高度谨慎，其研发可能既分散又薄弱，经营风险最高。
        """)
        
        st.success("""**阶段总结**：此图与之前“专利数量与各指标弱相关”的结论一致：**专利数量（气泡大小）并非决定企业技术质量的核心因素**。右上象限不乏专利量不大但质量极高的企业。 结合“企业规模vs指标分布图”，这类双高企业可能分布于各个规模段，尤其值得在 **中小型** 企业中挖掘。
        """)
    with stabs[2]:
        st.markdown("#### **评估资本市场对技术指标的筛选效应**")
        c_f1, c_f2, c_f3 = st.columns(3)
        with c_f1: 
            st.pyplot(vis.plot_funding_box(df_p, '支撑得分', '业务支撑指数'))
            st.markdown("""
            - **数据事实**：未获投企业的平均得分（50）显著高于获投企业（18）。
    
            - **客观解析**：这看似反直觉，但结合我们的样本结构（大量中小微企业）可推断：**本地多数技术扎实、研发高度聚焦的中小企业，尚未进入风险资本的视野**。资本市场可能更关注市场爆发力、团队背景或商业模式，而不仅仅看当前技术变现聚焦度。这揭示了 **“技术价值”与“资本价值”在当前本地市场存在认知错配或信息不对称**。

            - **总结**：可以**错位竞争**，利用“业务支撑指数”识别出这些**被VC忽略但技术路径清晰、经营稳健的“隐形优质企业”**.""")
        with c_f2: 
            st.pyplot(vis.plot_funding_box(df_p, '护城河得分', '技术护城河深度'))
            st.markdown("""
            - **数据事实**：未获投企业平均分与获投企业的差距很小（获投的样极少）。
    
            - **客观解析**：两者分值接近且都处于中高水平，表明 **“建立技术壁垒”是本地技术型企业的普遍共识和共同优势**。
    
            - **总结**：可将“技术护城河深度”视为一个 **“基础资格线”** ，用于筛选掉技术壁垒薄弱的企业，辅助挑选最优质的企业.
            """)
        with c_f3: 
            st.pyplot(vis.plot_funding_box(df_p, '覆盖得分', '产品技术覆盖率'))
            st.markdown("""
            - **数据事实**：获投企业平均分（60分）远超未获投企业平均分（35分左右），差距悬殊.
    
            - **客观解析**：可能表明，**“产品技术覆盖率”可作为风险管控指标参考**。投资者明确规避产品线存在“裸奔”风险的企业。

            - **总结**：可将“产品技术覆盖率”作为**风控的重要参考**。覆盖率低直接反映出企业知识产权管理有疏漏，有一定经营风险.
            """)



    with stabs[3]:
        st.markdown("### 指标随成立年限的动态演进")
        st.subheader("1. “老中青”分层对比分析")
        
        # --- 1. 业务支撑指数（研发聚焦度） ---
        st.markdown("#### **1. 业务支撑指数（研发聚焦度）**")
        st.pyplot(vis.plot_age_matrix_row(df_p, '支撑得分', '业务支撑指数'))
        st.markdown("""
        - **客观事实**：**老牌企业**平均得分最高（68.9分），显著高于青年企业（31.7分）与中坚企业（36.7分）。
        
        - **解析** ：随着成立年限越久，企业逐渐度过摸索期，**研发方向逐渐聚焦于核心业务**，技术变现路径最清晰。
        """)
        st.divider()

        # --- 2. 技术护城河深度 ---
        st.markdown("#### **2. 技术护城河深度**")
        st.pyplot(vis.plot_age_matrix_row(df_p, '护城河得分', '技术护城河深度'))
        st.markdown("""
        - **客观事实**：**老牌企业**平均得分依然显著领先（77.8分），青年企业（63.6）与老牌企业（62.2）相对较低，且接近。
        
        - **解析**：老牌企业不仅聚焦主业，且**在特定技术点上建立的壁垒最深**，竞争优势和抗风险能力最强，当然老牌企业也可能面临技术迭代放缓的挑战，被后来的企业追赶。
        """)
        st.divider()

        # --- 3. 产品技术覆盖率 ---
        st.markdown("#### **3. 产品技术覆盖率**")
        st.pyplot(vis.plot_age_matrix_row(df_p, '覆盖得分', '产品技术覆盖率'))
        st.markdown("""
        - **客观事实**：**老牌企业（55.7分）**，**青年企业**（24分）与中坚企业（26分），明显更好但仍有提升空间。
        
        - **解析**：**青年企业和中坚的产品“裸奔”风险相对较高**，这是其经营短板。而**老牌企业**则更注重产品技术的完善，这也是其指标较高的原因。总体来看随着成立的成立时间越久，整体的指标分布逐渐**向高分转移**，企业对于自己的产品的技术支持逐渐成熟。
        """)

        st.success("""**阶段总结**：**企业年龄**是解读其技术健康度的关键维度，但是并不是绝对代表成立年限越久地企业，其3个技术指标越高，在各指标维度仍然存在高分地中青企业。
        """)
        
        st.divider()
        # --- 2. 跨越 15 年的趋势波动 (波动带状图) ---
        st.subheader("2. 跨越 15 年的趋势波动 (波动带状图)")

        # --- 1. 业务支撑指数趋势（研发聚焦度） ---
        st.markdown("#### **1. 业务支撑指数趋势（研发聚焦度）**")
        st.pyplot(vis.plot_time_trend_sd(df_p, '支撑得分', '业务支撑指数', 'royalblue'))
        st.markdown("""
        - **整体趋势**：得分随年限 **先快速上升后趋于平稳或缓慢回落**。在成立初期（0-5年）得分较低且波动大，表明研发方向处于探索期；在5-15年间持续攀升并达到高峰，研发向主业聚焦；15年后可能持平或小幅下降，部分企业或因业务多元化而分散聚焦度。
        
        - **解析**：企业的研发聚焦能力在 **成立6-15年间达到最佳状态**，这是支持其扩大再生产、提升市场占有率的黄金窗口期。
        """)
        st.divider()

        # --- 2. 技术护城河深度趋势（壁垒强度） ---
        st.markdown("#### **2. 技术护城河深度趋势（壁垒强度）**")
        st.pyplot(vis.plot_time_trend_sd(df_p, '护城河得分', '技术护城河深度', 'seagreen'))
        st.markdown("""
        - **整体趋势**：得分随年限 **稳步上升，尤其在10-15年间加速提升**，15年后增速放缓或进入平台期。表明技术壁垒的构建需要时间积累，中坚企业通过持续研发形成了深厚的集群优势.
        
        - **关键洞察**：**护城河的构建具有“时间复利”效应**。成立10年以上的企业往往在特定技术点上建立了实质性壁垒，抗风险能力强。
        """)
        st.divider()

        # --- 3. 产品技术覆盖率趋势（风险覆盖） ---
        st.markdown("#### **3. 产品技术覆盖率趋势（风险覆盖）**")
        st.pyplot(vis.plot_time_trend_sd(df_p, '覆盖得分', '产品技术覆盖率', 'orange'))
        st.markdown("""
        - **整体趋势**：得分随年限 **持续改善但增速递减**。青年企业（0-5年）覆盖率低且提升缓慢，中坚企业（6-15年）快速提升，15年后改善幅度变小。这表明知识产权布局意识随企业发展逐步增强，但早期欠缺较多。
        
        - **关键洞察**：**覆盖率是典型的“历史欠账”指标**。年轻企业普遍“裸奔”，而老牌企业虽有所改善，但可能仍有历史遗留的薄弱环节。
        """)

        # --- 第五阶段 最终总结 ---
        st.success("""**阶段总结**：可以重点瞄准 **成立在6-15年的企业**，此时企业技术聚焦度与壁垒深度均处于上升通道，可以助推其突破成长瓶颈。对青年企业监控其覆盖率提升进度，对中坚企业关注其护城河深度变化，对老牌企业跟踪其业务支撑指数是否保持稳定。
        """)
        
# =================================================================
# 模块 3：企业专项审计报告（直读本地 PDF）
# =================================================================
elif selected_module == "📄 企业专项审计报告":
    st.title("📄 单体企业深度审计专项全案报告")
    
    # 锁定您的本地路径
    # 专项报告的路径也建议这样写
    report_path = os.path.join(BASE_DIR, "reports", "《四川天链机器人股份有限公司》专利业务匹配评估报告.pdf")
    
    st.markdown(f"**当前审计对象：** `四川天链机器人股份有限公司` | **报告来源：** 内部科研数据库")

    if os.path.exists(report_path):
        with st.spinner("正在加载深度审计报告..."):
            with open(report_path, "rb") as f:
                base64_pdf = base64.b64encode(f.read()).decode('utf-8')
            
            # 使用 PDF.js 风格嵌入或标准 iframe
            # 设置 height 为 1000 像素以获得最佳阅读体验
            pdf_display = f'<iframe src="data:application/pdf;base64,{base64_pdf}" width="100%" height="1000" type="application/pdf"></iframe>'
            st.markdown(pdf_display, unsafe_allow_html=True)
            
            st.success("✅ 报告已自动挂载，可直接进行翻阅、缩放或打印。")
    else:
        st.error(f"❌ 未在指定路径找到报告文件。请检查路径：\n`{report_path}`")

        st.info("💡 提示：请确保该 PDF 文件未被其他程序（如 Adobe Acrobat）独占锁定。")

